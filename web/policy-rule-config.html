<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automation Policy Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'IBM Plex Sans Thai', sans-serif;
        }

        [v-cloak] {
            display: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>

<body class="bg-slate-50">

    <div id="app" v-cloak>
        <!-- LOGIN PAGE (เหมือนเดิม) -->
        <div v-if="!isLoggedIn" class="min-h-screen flex items-center justify-center p-4 bg-slate-900">
            <div class="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-md">
                <div class="text-center mb-10">
                    <div class="inline-block p-4 bg-blue-100 rounded-2xl mb-4">
                        <svg class="w-12 h-12 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                            </path>
                        </svg>
                    </div>
                    <h1 class="text-3xl font-bold text-slate-800">System Login</h1>
                </div>
                <form @submit.prevent="handleLogin" class="space-y-6">
                    <input v-model="loginForm.username" type="text" placeholder="Username"
                        class="w-full px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                    <input v-model="loginForm.password" type="password" placeholder="Password"
                        class="w-full px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" :disabled="loading"
                        class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg transition disabled:opacity-50">
                        {{ loading ? 'กำลังตรวจสอบ...' : 'เข้าสู่ระบบ' }}
                    </button>
                </form>
            </div>
        </div>

        <!-- MAIN DASHBOARD -->
        <div v-else class="h-screen flex flex-col overflow-hidden">
            <header class="bg-white border-b px-8 py-4 flex justify-between items-center shadow-sm">
                <div class="flex items-center gap-4">
                    <div class="bg-blue-600 p-2 rounded-lg text-white font-bold">AS</div>
                    <h2 class="text-xl font-bold text-slate-800 tracking-tight">Policy Mapping Manager</h2>
                </div>
                <button @click="handleLogout"
                    class="text-red-500 hover:bg-red-50 p-2 rounded-full transition">Logout</button>
            </header>

            <div class="flex flex-1 overflow-hidden">
                <!-- Sidebar -->
                <aside class="w-96 bg-white border-r flex flex-col shadow-inner">
                    <div class="p-6 bg-slate-50 border-b">
                        <input v-model="searchQuery" type="text" placeholder="ค้นหาเงื่อนไข..."
                            class="w-full px-4 py-2 border rounded-lg text-sm">
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar">
                        <div v-for="cond in filteredConditions" :key="cond.condition_id"
                            @click="selectedCondId = cond.condition_id"
                            :class="['p-5 border-b cursor-pointer transition-all hover:bg-slate-50', selectedCondId === cond.condition_id ? 'bg-blue-50 border-r-4 border-blue-600' : '']">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-xs font-black px-2 py-0.5 rounded bg-blue-100 text-blue-600">{{
                                    cond.condition_type }}</span>
                            </div>
                            <p class="font-bold text-slate-800">{{ cond.condition_name }}</p>
                            <p class="text-xs text-slate-500 font-mono">{{ cond.condition_code }}</p>
                        </div>
                    </div>
                </aside>

                <!-- Content Area -->
                <main class="flex-1 overflow-y-auto p-10 custom-scrollbar">
                    <div v-if="selectedCondition" class="max-w-5xl mx-auto space-y-10">

                        <div class="flex justify-between items-end border-b border-slate-200 pb-8">
                            <div>
                                <h1 class="text-4xl font-black text-slate-900 tracking-tight">{{
                                    selectedCondition.condition_name }}</h1>
                                <p class="text-slate-500 mt-2 font-mono uppercase text-sm">ID: {{
                                    selectedCondition.condition_id }}</p>
                            </div>
                            <button @click="savePolicy" :disabled="saving"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-2xl font-bold shadow-xl transition disabled:opacity-50">
                                {{ saving ? 'กำลังบันทึกข้อมูล 3 ส่วน...' : 'บันทึกนโยบายทั้งหมด' }}
                            </button>
                        </div>

                        <div class="grid grid-cols-1 gap-8">
                            <!-- Operators Section -->
                            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                                <div class="px-8 py-5 bg-slate-50/50 border-b flex justify-between items-center">
                                    <h3 class="font-bold text-slate-700">1. Allowed Operators</h3>
                                    <span class="text-xs text-slate-400">Total: {{ currentOperators.length }}</span>
                                </div>
                                <div class="p-8 flex flex-wrap gap-3">
                                    <button v-for="op in config.Operators" :key="op.operator_id"
                                        @click="toggleOperator(op.operator_id)"
                                        :class="['px-6 py-3 rounded-xl border-2 font-mono text-sm transition-all', 
                                        isOpActive(op.operator_id) ? 'bg-slate-900 border-slate-900 text-white shadow-md' : 'bg-white border-slate-100 text-slate-400']">
                                        {{ op.operator_symbol }}
                                    </button>
                                </div>
                            </div>

                            <!-- Units Section -->
                            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                                <div class="px-8 py-5 bg-slate-50/50 border-b flex justify-between items-center">
                                    <h3 class="font-bold text-slate-700">2. Allowed Units</h3>
                                    <span class="text-xs text-slate-400">Total: {{ currentUnits.length }}</span>
                                </div>
                                <div class="p-8 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                    <div v-for="unit in config.Units" :key="unit.unit_id"
                                        @click="toggleUnit(unit.unit_id)"
                                        :class="['flex items-center p-4 rounded-xl border-2 cursor-pointer transition-all', 
                                        isUnitActive(unit.unit_id) ? 'bg-blue-50 border-blue-500 text-blue-700' : 'bg-white border-slate-50 text-slate-400']">
                                        <span class="text-sm font-bold truncate uppercase">{{ unit.unit_name }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Actions Section -->
                            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                                <div class="px-8 py-5 bg-slate-50/50 border-b flex justify-between items-center">
                                    <h3 class="font-bold text-slate-700">3. Trigger Actions</h3>
                                    <span class="text-xs text-slate-400">Total: {{ currentActions.length }}</span>
                                </div>
                                <div class="divide-y divide-slate-100">
                                    <div v-for="action in config.Actions" :key="action.action_id"
                                        @click="toggleAction(action.action_id)"
                                        class="p-6 flex items-center justify-between hover:bg-slate-50 cursor-pointer transition">
                                        <div class="flex items-center">
                                            <div
                                                :class="['w-12 h-12 rounded-xl flex items-center justify-center mr-6', isActionActive(action.action_id) ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-400']">
                                                ⚡
                                            </div>
                                            <p
                                                :class="['font-bold', isActionActive(action.action_id) ? 'text-slate-900' : 'text-slate-400']">
                                                {{ action.action_name }}</p>
                                        </div>
                                        <div
                                            :class="['px-4 py-1 rounded-full text-[10px] font-black uppercase tracking-widest', isActionActive(action.action_id) ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-300']">
                                            {{ isActionActive(action.action_id) ? 'Enabled' : 'Disabled' }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Empty State -->
                    <div v-else class="h-full flex items-center justify-center text-slate-300 font-bold">
                        กรุณาเลือกเงื่อนไขจากรายการด้านซ้ายมือ
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const API_BASE = ''; // ใส่ URL ของ API เช่น http://your-api.com

                const isLoggedIn = ref(!!localStorage.getItem('token'));
                const token = ref(localStorage.getItem('token'));
                const loading = ref(false);
                const saving = ref(false);
                const searchQuery = ref('');
                const selectedCondId = ref(null);
                const loginForm = ref({ username: 'admin', password: 'password123' });

                const config = ref({
                    Conditions: [], Operators: [], Units: [], Actions: [],
                    ConditionOperators: [], ConditionUnits: [], ConditionActions: []
                });

                // Fetch Data
                const fetchRuleConfig = async () => {
                    if (!token.value) return;
                    try {
                        const res = await fetch(`${API_BASE}/api/v1/policy/rule-config`, {
                            headers: { 'Authorization': `Bearer ${token.value}` }
                        });
                        const data = await res.json();
                        config.value = data;
                    } catch (err) {
                        console.error('Fetch error:', err);
                    }
                };

                // Mapping Checkers
                const isOpActive = (id) => config.value.ConditionOperators.some(m => m.condition_id === selectedCondId.value && m.operator_id === id);
                const isUnitActive = (id) => config.value.ConditionUnits.some(m => m.condition_id === selectedCondId.value && m.unit_id === id);
                const isActionActive = (id) => config.value.ConditionActions.some(m => m.condition_id === selectedCondId.value && m.action_id === id);

                // Toggle Functions
                const toggleOperator = (id) => {
                    const list = config.value.ConditionOperators;
                    const idx = list.findIndex(m => m.condition_id === selectedCondId.value && m.operator_id === id);
                    if (idx > -1) list.splice(idx, 1);
                    else list.push({ condition_id: selectedCondId.value, operator_id: id });
                };
                const toggleUnit = (id) => {
                    const list = config.value.ConditionUnits;
                    const idx = list.findIndex(m => m.condition_id === selectedCondId.value && m.unit_id === id);
                    if (idx > -1) list.splice(idx, 1);
                    else list.push({ condition_id: selectedCondId.value, unit_id: id });
                };
                const toggleAction = (id) => {
                    const list = config.value.ConditionActions;
                    const idx = list.findIndex(m => m.condition_id === selectedCondId.value && m.action_id === id);
                    if (idx > -1) list.splice(idx, 1);
                    else list.push({ condition_id: selectedCondId.value, action_id: id });
                };

                // ดึงข้อมูลปัจจุบันเพื่อเตรียมส่ง API
                const currentOperators = computed(() => config.value.ConditionOperators.filter(m => m.condition_id === selectedCondId.value));
                const currentUnits = computed(() => config.value.ConditionUnits.filter(m => m.condition_id === selectedCondId.value));
                const currentActions = computed(() => config.value.ConditionActions.filter(m => m.condition_id === selectedCondId.value));

                // ==========================================
                // ฟังก์ชันบันทึกข้อมูล (API Integration)
                // ==========================================
                const savePolicy = async () => {
                    if (!selectedCondId.value) return;
                    saving.value = true;

                    const commonBody = {
                        condition_id: selectedCondId.value,
                        created_by: "system"
                    };

                    const headers = {
                        'Authorization': `Bearer ${token.value}`,
                        'Content-Type': 'application/json'
                    };

                    try {
                        // เตรียม Request ทั้ง 3 ตัว
                        const opPromise = fetch(`${API_BASE}/api/v1/policy/condition-operators`, {
                            method: 'POST',
                            headers,
                            body: JSON.stringify({
                                ...commonBody,
                                operators: currentOperators.value.map(o => ({ operator_id: o.operator_id }))
                            })
                        });

                        const unitPromise = fetch(`${API_BASE}/api/v1/policy/condition-units`, {
                            method: 'POST',
                            headers,
                            body: JSON.stringify({
                                ...commonBody,
                                units: currentUnits.value.map(u => ({ unit_id: u.unit_id }))
                            })
                        });

                        const actionPromise = fetch(`${API_BASE}/api/v1/policy/condition-actions`, {
                            method: 'POST',
                            headers,
                            body: JSON.stringify({
                                ...commonBody,
                                actions: currentActions.value.map(a => ({ action_id: a.action_id }))
                            })
                        });

                        // รันทั้ง 3 API พร้อมกัน และรอให้สำเร็จทั้งหมด
                        const responses = await Promise.all([opPromise, unitPromise, actionPromise]);

                        // ตรวจสอบเบื้องต้นว่ามีตัวไหนพังไหม
                        for (let r of responses) {
                            if (!r.ok) throw new Error(`API Error: ${r.statusText}`);
                        }

                        alert('บันทึกนโยบายสำเร็จครบถ้วนทั้ง 3 ส่วน!');

                        // fetch data ใหม่เพื่อความถูกต้องของ State
                        await fetchRuleConfig();

                    } catch (err) {
                        alert('เกิดข้อผิดพลาดในการบันทึก: ' + err.message);
                    } finally {
                        saving.value = false;
                    }
                };

                // Login / Logout (เหมือนเดิม)
                const handleLogin = async () => {
                    loading.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/api/v1/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(loginForm.value)
                        });
                        const data = await res.json();
                        if (data.token) {
                            token.value = data.token;
                            localStorage.setItem('token', data.token);
                            isLoggedIn.value = true;
                            fetchRuleConfig();
                        }
                    } catch (err) { alert('Login failed'); }
                    finally { loading.value = false; }
                };

                const handleLogout = () => {
                    localStorage.removeItem('token');
                    isLoggedIn.value = false;
                    token.value = null;
                };

                onMounted(() => { if (isLoggedIn.value) fetchRuleConfig(); });

                return {
                    isLoggedIn, loginForm, handleLogin, handleLogout,
                    config, searchQuery, selectedCondId,
                    filteredConditions: computed(() => config.value.Conditions.filter(c => c.condition_name.includes(searchQuery.value))),
                    selectedCondition: computed(() => config.value.Conditions.find(c => c.condition_id === selectedCondId.value)),
                    isOpActive, isUnitActive, isActionActive,
                    toggleOperator, toggleUnit, toggleAction, savePolicy,
                    currentOperators, currentUnits, currentActions,
                    loading, saving
                };
            }
        }).mount('#app');
    </script>
</body>

</html>